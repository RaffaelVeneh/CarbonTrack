const Groq = require('groq-sdk');

// Initialize Groq client
const groq = new Groq({
    apiKey: process.env.GROQ_API_KEY || 'gsk_your_api_key_here' // Ganti dengan API key Groq
});

// System prompt untuk EcoBot personality
const SYSTEM_PROMPT = `Kamu adalah EcoBot, asisten virtual ramah lingkungan yang membantu pengguna mengurangi jejak karbon mereka. 

PERSONALITY:
- Ramah, antusias, dan supportif
- Gunakan emoji yang relevan (ğŸŒ±ğŸ’¡ğŸš—â™»ï¸ğŸ’§ğŸŒ)
- Berikan tips praktis dan actionable
- Fokus pada solusi, bukan menakut-nakuti
- Gunakan bahasa Indonesia yang casual tapi informatif

EXPERTISE:
1. Hemat energi listrik (AC, lampu, elektronik)
2. Transportasi ramah lingkungan (sepeda, carpool, public transport)
3. Diet rendah karbon (kurangi daging, pilih lokal)
4. Kurangi sampah plastik (reusable items, kompos)
5. Hemat air
6. Fakta climate change & lingkungan di Indonesia
7. Fitur aplikasi CarbonTrack (level, XP, missions)

RESPONSE FORMAT:
- Jawab singkat (2-4 paragraf)
- Gunakan bullet points untuk tips
- Sertakan angka/data untuk kredibilitas
- Berikan action items yang bisa langsung dipraktikkan
- Tutup dengan motivasi positif

Jangan bahas topik di luar lingkungan/sustainability. Jika ditanya hal lain, arahkan kembali ke topik eco-living.`;

exports.askAssistant = async (req, res) => {
    try {
        const { question } = req.body;
        
        if (!question || !question.trim()) {
            return res.json({ answer: "Halo! Ada yang bisa EcoBot bantu? ğŸŒ±" });
        }

        console.log(`[AI] User asked: "${question.substring(0, 100)}..."`);

        // === GROQ AI INTEGRATION ===
        try {
            const chatCompletion = await groq.chat.completions.create({
                messages: [
                    {
                        role: 'system',
                        content: SYSTEM_PROMPT
                    },
                    {
                        role: 'user',
                        content: question
                    }
                ],
                model: 'llama-3.3-70b-versatile', // Model tercepat & terbaik Groq
                temperature: 0.7,
                max_tokens: 800,
                top_p: 1,
                stream: false
            });

            const answer = chatCompletion.choices[0]?.message?.content || 
                "Maaf, EcoBot sedang berpikir terlalu dalam. Coba tanya lagi ya! ğŸ˜…";
            
            console.log(`[AI] Response length: ${answer.length} chars`);
            return res.json({ answer });

        } catch (groqError) {
            console.error('[Groq API Error]:', groqError.message);
            
            // FALLBACK ke keyword matching jika Groq error
            const lowerQ = question.toLowerCase().trim();
            let answer = "Maaf, EcoBot sedang maintenance. Coba tanya tentang hemat energi, transportasi, atau sampah plastik! ğŸ˜Š";

        // --- ENHANCED KEYWORD MATCHING ---

        // 1. SAPAAN & TERIMA KASIH
        if (/^(halo|hai|hi|hello|hey|pagi|siang|sore|malam)$/i.test(lowerQ)) {
            answer = "Halo sobat bumi! ğŸŒ± Ada yang bisa EcoBot bantu untuk kurangi jejak karbonmu hari ini?";
        }
        else if (/terima kasih|thanks|makasih/i.test(lowerQ)) {
            answer = "Sama-sama! ğŸ’š Senang bisa membantu. Yuk terus jaga bumi kita bersama!";
        }
        
        // 2. PERTANYAAN TENTANG ECOBOT
        else if (/siapa (kamu|anda|kau)|apa itu ecobot|kamu siapa/i.test(lowerQ)) {
            answer = "Aku EcoBot! ğŸ¤– Asisten virtual yang siap bantu kamu mengurangi jejak karbon. Tanya aku tentang tips hemat energi, transportasi hijau, diet ramah lingkungan, dan cara kurangi sampah plastik!";
        }
        else if (/bisa apa|fitur|fungsi|kemampuan/i.test(lowerQ)) {
            answer = "EcoBot bisa bantu kamu dengan:\n\nğŸ’¡ Tips hemat listrik & energi\nğŸš— Transportasi ramah lingkungan\nğŸ” Diet rendah karbon\nâ™»ï¸ Cara kurangi sampah plastik\nğŸ’§ Hemat air\nğŸ“Š Fakta & data lingkungan\nğŸ¯ Cara naik level di aplikasi\n\nTanya aja yang kamu butuhkan!";
        }
        
        // 3. LISTRIK & ENERGI
        else if (/listrik|lampu|ac|kipas|kulkas|energi|hemat listrik|tagihan listrik/i.test(lowerQ)) {
            const tips = [
                "ğŸ’¡ **Tips Hemat Energi:**\n\n1. **AC di 24-25Â°C** - Setiap derajat lebih dingin = 3-5% listrik lebih boros\n2. **Ganti lampu LED** - Hemat 75% energi vs lampu pijar\n3. **Cabut charger** - Charger yang nganggur tetap makan listrik ('vampire power')\n4. **Bersihkan filter AC** - AC kotor boros hingga 15%\n5. **Matikan standby** - TV/komputer standby tetap konsumsi 5-10W",
                "âš¡ **Fakta Listrik:**\n\nâ€¢ Rumah tangga Indonesia rata-rata pakai 186 kWh/bulan\nâ€¢ 1 kWh listrik = 0.85 kg CO2\nâ€¢ AC menyumbang 40% konsumsi listrik rumah\n\nğŸ’¡ **Quick Tips:**\n- Matikan lampu ruangan kosong\n- Gunakan natural light saat siang\n- Isi kulkas 75% penuh (terlalu kosong boros)",
                "ğŸŒ **Alternatif Energi:**\n\n1. Pertimbangkan panel surya (balik modal 5-7 tahun)\n2. Gunakan water heater solar\n3. Pasang smart power strip untuk matikan otomatis\n4. Ganti ke perangkat energy star certified"
            ];
            answer = tips[Math.floor(Math.random() * tips.length)];
        }
        
        // 4. TRANSPORTASI
        else if (/motor|mobil|bensin|transport|kendaraan|macet|jalan|sepeda|naik|ojek/i.test(lowerQ)) {
            const tips = [
                "ğŸš— **Tips Berkendara Hemat:**\n\n1. **Cek tekanan ban** - Ban kurang angin boros BBM 3-5%\n2. **Hindari 'Stop & Go'** - Akselerasi halus hemat 20% bensin\n3. **Maintenance rutin** - Ganti oli tepat waktu\n4. **Lepas beban** - Setiap 50kg beban = 2% BBM\n5. **Matikan mesin** - Tunggu >60 detik? Matikan aja",
                "ğŸš´ **Transportasi Hijau:**\n\nâ€¢ **Sepeda/Jalan kaki** (<3km) = 0 emisi!\nâ€¢ **Bus/KRL** = 0.04 kg CO2/km (mobil 0.19 kg/km)\nâ€¢ **Carpool** = Bagi emisi dengan teman!\nâ€¢ **Motor** lebih hemat 50% vs mobil solo\n\nğŸ’š Coba 'car-free day' seminggu sekali!",
                "â›½ **Fakta Transportasi:**\n\nâ€¢ 1 liter bensin = 2.3 kg CO2\nâ€¢ Jarak rata-rata kerja: 10 km/hari\nâ€¢ Mobil solo 1 bulan = 80 kg CO2\nâ€¢ Naik KRL 1 bulan = 10 kg CO2\n\nğŸ¯ Hemat BBM = Hemat duit + Jaga lingkungan!"
            ];
            answer = tips[Math.floor(Math.random() * tips.length)];
        }
        
        // 5. MAKANAN & DIET
        else if (/makan|daging|sapi|ayam|sayur|vegetarian|vegan|diet|protein/i.test(lowerQ)) {
            const tips = [
                "ğŸ” **Diet Rendah Karbon:**\n\n**Emisi per 1kg:**\nâ€¢ Daging sapi: 27 kg CO2\nâ€¢ Daging ayam: 6.9 kg CO2\nâ€¢ Ikan: 5.4 kg CO2\nâ€¢ Telur: 4.8 kg CO2\nâ€¢ Tempe/Tahu: 2 kg CO2\n\nğŸ’¡ Coba 'Meatless Monday' (Senin Tanpa Daging)!",
                "ğŸ¥— **Tips Makan Ramah Lingkungan:**\n\n1. Kurangi daging merah (3x/minggu â†’ 1x/minggu)\n2. Pilih protein lokal (tempe, tahu, telur)\n3. Beli sayur lokal & musiman\n4. Hindari food waste (30% makanan terbuang!)\n5. Kompos sisa sayuran\n\nğŸŒ± Diet fleksitarian = hemat 500 kg CO2/tahun!",
                "ğŸ– **Fakta Industri Daging:**\n\nâ€¢ Peternakan = 14.5% emisi global\nâ€¢ 1 burger sapi = 50km naik mobil\nâ€¢ Butuh 15,000 liter air untuk 1 kg daging sapi!\n\nğŸ’š Solusi: Kurangi porsi daging, perbanyak sayur"
            ];
            answer = tips[Math.floor(Math.random() * tips.length)];
        }
        
        // 6. SAMPAH & PLASTIK
        else if (/sampah|plastik|botol|sedotan|kantong|belanja|limbah|recycle/i.test(lowerQ)) {
            const tips = [
                "â™»ï¸ **Lawan Sampah Plastik:**\n\n1. **Bawa tumbler** - 1 botol plastik = 450 tahun terurai!\n2. **Tas belanja sendiri** - Hemat 500 kantong plastik/tahun\n3. **Tolak sedotan** - Indonesia pakai 93 juta sedotan/hari\n4. **Pilih refill** - Sabun, shampo, detergen\n5. **Kompos organik** - 60% sampah bisa kompos\n\nğŸ’° Bonus: Hemat Rp 500rb/tahun!",
                "ğŸŒŠ **Fakta Plastik:**\n\nâ€¢ Indonesia = penyumbang plastik laut #2 dunia\nâ€¢ 8 juta ton plastik masuk laut tiap tahun\nâ€¢ 1 truk sampah plastik/menit ke laut\nâ€¢ Mikroplastik ada di air minum kita!\n\nğŸ¯ Mulai dari diri sendiri: Refuse, Reduce, Reuse!",
                "ğŸ—‘ï¸ **Cara Kurangi Sampah:**\n\n1. Beli bulk (curah) tanpa kemasan\n2. Pilih produk kemasan kertas/kaca\n3. Perbaiki barang rusak, jangan beli baru\n4. Donate pakaian bekas\n5. Pilah sampah (organik/anorganik)\n\nğŸ’¡ Zero waste lifestyle dimulai dari langkah kecil!"
            ];
            answer = tips[Math.floor(Math.random() * tips.length)];
        }
        
        // 7. AIR
        else if (/air|mandi|cuci|kran|sikat gigi|water/i.test(lowerQ)) {
            answer = "ğŸ’§ **Hemat Air:**\n\n1. **Matikan kran** saat gosok gigi (hemat 6 liter/menit)\n2. **Mandi 5-10 menit** (tiap menit = 10 liter)\n3. **Cuci piring efisien** - jangan air mengalir terus\n4. **Tampung air AC** untuk siram tanaman\n5. **Perbaiki kran bocor** (1 tetes/detik = 20 liter/hari)\n\nğŸš¿ Rata-rata orang pakai 120 liter/hari. Yuk kurangi!";
        }
        
        // 8. LEVEL & XP
        else if (/level|xp|poin|naik|mission|misi/i.test(lowerQ)) {
            answer = "ğŸ“ˆ **Sistem Level & XP:**\n\n**Cara Dapat XP:**\nâ€¢ Catat aktivitas hijau (+5-20 XP)\nâ€¢ Selesaikan misi (+30-600 XP)\nâ€¢ Konsisten hemat karbon (+bonus XP)\n\n**Level Up:**\nâ€¢ Level 1-10: 100 XP per level\nâ€¢ Unlock misi baru setiap naik level!\nâ€¢ Tingkatkan island health\n\nğŸ¯ Catat aktivitas rutin untuk naik level cepat!";
        }
        
        // 9. FAKTA LINGKUNGAN
        else if (/fakta|data|global warming|iklim|perubahan iklim|climate/i.test(lowerQ)) {
            const facts = [
                "ğŸŒ **Fakta Climate Change:**\n\nâ€¢ Suhu global naik 1.1Â°C sejak 1880\nâ€¢ 2023 = tahun terpanas dalam sejarah\nâ€¢ Es Antartika mencair 150 miliar ton/tahun\nâ€¢ Level laut naik 20cm dalam 100 tahun\n\nâ° Kita punya <10 tahun untuk aksi drastis!",
                "ğŸ”¥ **Dampak Indonesia:**\n\nâ€¢ Jakarta turun 25 cm dalam 10 tahun\nâ€¢ Banjir rob makin sering\nâ€¢ Kekeringan & gagal panen meningkat\nâ€¢ Kebakaran hutan 2019 = 1.6 juta hektar\n\nğŸ’š Setiap aksi kecil PENTING!",
                "â™»ï¸ **Sumber Emisi Global:**\n\n1. Energi (listrik/panas): 25%\n2. Pertanian & hutan: 24%\n3. Industri: 21%\n4. Transportasi: 14%\n5. Bangunan: 6%\n\nğŸ¯ Fokus ke yang bisa kita kontrol: energi, transport, makanan!"
            ];
            answer = facts[Math.floor(Math.random() * facts.length)];
        }
        
        // 10. CARA MULAI / BINGUNG
        else if (/mulai|bingung|gimana|bagaimana|cara|langkah/i.test(lowerQ)) {
            answer = "ğŸŒ± **Mulai dari Mana?**\n\n**Langkah Mudah:**\n1. âœ… Matikan lampu ruangan kosong\n2. âœ… Bawa botol minum & tas belanja\n3. âœ… Jalan kaki/sepeda untuk jarak dekat\n4. âœ… Kurangi makan daging 1-2x/minggu\n5. âœ… Cabut charger setelah penuh\n\nğŸ“± **Di App ini:**\n- Catat aktivitas harian kamu\n- Selesaikan misi\n- Track progress jejak karbon\n\nğŸ’ª Konsisten = Kunci sukses!";
        }

        // Log untuk monitoring
        console.log(`[AI] User asked: "${question.substring(0, 50)}..."`);
        
        res.json({ answer });

    } catch (error) {
        console.error('[AI Error]:', error);
        res.status(500).json({ answer: 'Maaf, EcoBot sedang perbaikan sistem. Coba lagi ya! ğŸ”§' });
    }
};